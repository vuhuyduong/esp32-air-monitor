<!DOCTYPE html>
<html lang="vi" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Air Monitor - So sánh Trong nhà & Ngoài trời</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        :root { --chart-grid-color: rgba(0, 0, 0, 0.1); --card-bg: #ffffff; }
        [data-bs-theme="dark"] { --chart-grid-color: rgba(255, 255, 255, 0.1); --card-bg: #212529; }
        
        body { font-family: 'Inter', sans-serif; transition: 0.3s; }
        .card { border: none; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); background-color: var(--card-bg); }
        
        /* Range Bar Styles */
        .range-container { position: relative; height: 30px; background: #e9ecef; border-radius: 15px; margin-top: 15px; overflow: hidden; }
        .range-safe-zone { position: absolute; height: 100%; background-color: rgba(25, 135, 84, 0.2); border-left: 2px solid #198754; border-right: 2px solid #198754; z-index: 1; }
        .marker { position: absolute; top: -5px; width: 2px; height: 40px; background: #000; z-index: 10; transition: left 1s ease-out; }
        .marker-icon { position: absolute; top: -25px; left: -12px; font-size: 1.2rem; }
        .marker.indoor { background: #0d6efd; }
        .marker.indoor .marker-icon { color: #0d6efd; }
        .marker.outdoor { background: #6c757d; height: 20px; top: 15px; } /* Marker ngoài trời nằm dưới */
        .marker.outdoor .marker-icon { top: 20px; color: #6c757d; }

        /* AQI Badge Colors */
        .bg-aqi-good { background-color: #009966; color: white; }
        .bg-aqi-mod { background-color: #ffde33; color: black; }
        .bg-aqi-unhealthy-sens { background-color: #ff9933; color: white; }
        .bg-aqi-unhealthy { background-color: #cc0033; color: white; }
        .bg-aqi-very { background-color: #660099; color: white; }
        .bg-aqi-haz { background-color: #7e0023; color: white; }
    </style>
</head>
<body class="bg-body-tertiary">

    <nav class="navbar navbar-expand-lg sticky-top bg-body shadow-sm">
        <div class="container">
            <a class="navbar-brand fw-bold" href="#"><i class="fa-solid fa-wind text-primary"></i> AirMonitor</a>
            <div class="d-flex align-items-center gap-3">
                <div class="text-end d-none d-sm-block">
                    <div class="fw-bold small"><i class="fa-solid fa-location-dot text-danger"></i> Vũ Phạm Hàm, HN</div>
                    <div class="small text-muted" id="clock">--:--:--</div>
                </div>
                <button class="btn btn-outline-secondary rounded-circle" id="themeToggle"><i class="fa-solid fa-moon"></i></button>
            </div>
        </div>
    </nav>

    <div class="container py-4">
        <div class="row g-4 mb-4">
            
            <div class="col-md-4">
                <div class="card h-100 p-3">
                    <h6 class="text-uppercase text-muted small fw-bold mb-3">Chất lượng không khí (AQI)</h6>
                    <div class="d-flex justify-content-between align-items-end mb-2">
                        <div>
                            <div class="display-4 fw-bold text-primary" id="aqi-in">--</div>
                            <span class="badge bg-primary">Trong nhà</span>
                        </div>
                        <div class="text-end">
                            <div class="h3 text-secondary" id="aqi-out">--</div>
                            <span class="badge bg-secondary">Ngoài trời</span>
                        </div>
                    </div>
                    
                    <div class="range-wrapper mt-3">
                        <div class="d-flex justify-content-between small text-muted mb-1">
                            <span>Tốt (0)</span>
                            <span>Nguy hại (300+)</span>
                        </div>
                        <div class="range-container">
                            <div class="range-safe-zone" style="left: 0%; width: 16.6%; background-color: #009966;"></div>
                            <div class="range-safe-zone" style="left: 16.6%; width: 16.6%; background-color: #ffde33;"></div>
                            
                            <div id="marker-aqi-in" class="marker indoor" style="left: 0%;">
                                <i class="fa-solid fa-house marker-icon"></i>
                            </div>
                            <div id="marker-aqi-out" class="marker outdoor" style="left: 0%;">
                                <i class="fa-solid fa-cloud marker-icon"></i>
                            </div>
                        </div>
                        <div class="mt-2 text-center small fst-italic" id="aqi-advice">Đang tải...</div>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card h-100 p-3">
                    <h6 class="text-uppercase text-muted small fw-bold mb-3">Nhiệt độ (°C)</h6>
                    <div class="d-flex justify-content-between align-items-end mb-2">
                        <div>
                            <div class="display-4 fw-bold text-danger" id="temp-in">--</div>
                            <span class="badge bg-danger">Trong nhà</span>
                        </div>
                        <div class="text-end">
                            <div class="h3 text-secondary" id="temp-out">--</div>
                            <span class="badge bg-secondary">Ngoài trời</span>
                        </div>
                    </div>

                    <div class="range-wrapper mt-3">
                        <div class="d-flex justify-content-between small text-muted mb-1">
                            <span>10°C</span>
                            <span>40°C</span>
                        </div>
                        <div class="range-container">
                            <div class="range-safe-zone" style="left: 33%; width: 26%;"></div> <div id="marker-temp-in" class="marker indoor" style="left: 0%;">
                                <i class="fa-solid fa-house marker-icon"></i>
                            </div>
                            <div id="marker-temp-out" class="marker outdoor" style="left: 0%;">
                                <i class="fa-solid fa-cloud marker-icon"></i>
                            </div>
                        </div>
                        <div class="mt-2 text-center small text-muted">Vùng thoải mái: 20°C - 28°C</div>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card h-100 p-3">
                    <h6 class="text-uppercase text-muted small fw-bold mb-3">Độ ẩm (%)</h6>
                    <div class="d-flex justify-content-between align-items-end mb-2">
                        <div>
                            <div class="display-4 fw-bold text-info" id="hum-in">--</div>
                            <span class="badge bg-info">Trong nhà</span>
                        </div>
                        <div class="text-end">
                            <div class="h3 text-secondary" id="hum-out">--</div>
                            <span class="badge bg-secondary">Ngoài trời</span>
                        </div>
                    </div>

                    <div class="range-wrapper mt-3">
                        <div class="d-flex justify-content-between small text-muted mb-1">
                            <span>20%</span>
                            <span>100%</span>
                        </div>
                        <div class="range-container">
                            <div class="range-safe-zone" style="left: 25%; width: 25%;"></div>
                            
                            <div id="marker-hum-in" class="marker indoor" style="left: 0%;">
                                <i class="fa-solid fa-house marker-icon"></i>
                            </div>
                            <div id="marker-hum-out" class="marker outdoor" style="left: 0%;">
                                <i class="fa-solid fa-cloud marker-icon"></i>
                            </div>
                        </div>
                        <div class="mt-2 text-center small text-muted">Vùng thoải mái: 40% - 60%</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card p-3 mb-4">
            <h6 class="fw-bold mb-3">Biểu đồ theo dõi (Trong nhà)</h6>
            <canvas id="mainChart" height="100"></canvas>
        </div>
        
        <div class="text-center text-muted small">
            Dữ liệu ngoài trời cung cấp bởi Open-Meteo API (Tọa độ: Vũ Phạm Hàm)
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
        // --- CẤU HÌNH ---
        // Thay URL Google Script của anh vào đây
        const GAS_URL = "https://script.google.com/macros/s/AKfycbyzwQubYecHa6ufT30CVHOX2WijC78SLCkH3uhVrwhOcGaulakZ6QuzzVnjQy6TGTq7Mg/exec"; 
        
        // Tọa độ Vũ Phạm Hàm, Hà Nội
        const LAT = 21.013;
        const LON = 105.799;

        // API Open-Meteo (Không cần Key)
        const OUTDOOR_WEATHER_API = `https://api.open-meteo.com/v1/forecast?latitude=${LAT}&longitude=${LON}&current=temperature_2m,relative_humidity_2m&timezone=Asia%2FBangkok`;
        const OUTDOOR_AQI_API = `https://air-quality-api.open-meteo.com/v1/air-quality?latitude=${LAT}&longitude=${LON}&current=us_aqi&timezone=Asia%2FBangkok`;

        // Đồng hồ
        setInterval(() => document.getElementById('clock').innerText = new Date().toLocaleTimeString('vi-VN'), 1000);
        document.getElementById('themeToggle').addEventListener('click', () => {
            const h = document.documentElement;
            h.setAttribute('data-bs-theme', h.getAttribute('data-bs-theme')==='dark'?'light':'dark');
        });

        // HÀM CHÍNH: Lấy dữ liệu
        async function fetchAllData() {
            try {
                // 1. Gọi song song 3 API (Google Script, Weather, AQI)
                const [resIndoor, resWeather, resAqi] = await Promise.all([
                    fetch(GAS_URL).then(r => r.json()),
                    fetch(OUTDOOR_WEATHER_API).then(r => r.json()),
                    fetch(OUTDOOR_AQI_API).then(r => r.json())
                ]);

                // 2. Xử lý dữ liệu Trong nhà
                if(resIndoor.status === 'success') {
                    const d = resIndoor.current;
                    const aqiIn = d.aqi || calcAQI(d.pm25);
                    
                    updateMetric('aqi', aqiIn, 'in', 0, 300); // Scale AQI 0-300
                    updateMetric('temp', d.temp, 'in', 10, 40); // Scale Temp 10-40
                    updateMetric('hum', d.hum, 'in', 20, 100); // Scale Hum 20-100
                    
                    drawChart(resIndoor.history);
                    
                    // Logic So sánh & Lời khuyên
                    compareAndAdvise(aqiIn, resAqi.current.us_aqi);
                }

                // 3. Xử lý dữ liệu Ngoài trời
                if(resWeather.current && resAqi.current) {
                    updateMetric('temp', resWeather.current.temperature_2m, 'out', 10, 40);
                    updateMetric('hum', resWeather.current.relative_humidity_2m, 'out', 20, 100);
                    updateMetric('aqi', resAqi.current.us_aqi, 'out', 0, 300);
                }

            } catch (e) {
                console.error("Lỗi:", e);
            }
        }

        // Hàm cập nhật số và vị trí thanh trượt
        function updateMetric(type, value, loc, min, max) {
            // Update số
            const elVal = document.getElementById(`${type}-${loc}`);
            if(elVal) elVal.innerText = Math.round(value);

            // Update vị trí marker
            // Tính phần trăm: (value - min) / (max - min) * 100
            let percent = ((value - min) / (max - min)) * 100;
            if(percent < 0) percent = 0;
            if(percent > 100) percent = 100;

            const elMarker = document.getElementById(`marker-${type}-${loc}`);
            if(elMarker) elMarker.style.left = `${percent}%`;
        }

        // Logic đưa ra lời khuyên thông minh
        function compareAndAdvise(aqiIn, aqiOut) {
            const div = document.getElementById('aqi-advice');
            let msg = "";
            let color = "text-muted";

            if (aqiIn > 100) {
                msg = "Cảnh báo: Không khí trong nhà xấu! ";
                color = "text-danger fw-bold";
                if (aqiOut < aqiIn) msg += "Ngoài trời sạch hơn, hãy mở cửa sổ ngay.";
                else msg += "Nhưng ngoài trời cũng bẩn, hãy bật máy lọc khí và đóng kín cửa.";
            } else {
                if (aqiOut > 150) {
                    msg = "Ngoài trời rất bụi. Tuyệt đối không mở cửa sổ lúc này.";
                    color = "text-warning fw-bold";
                } else {
                    msg = "Không khí trong nhà ổn định.";
                    color = "text-success";
                }
            }
            div.className = `mt-2 text-center small fst-italic ${color}`;
            div.innerText = msg;
        }

        // Hàm tính AQI fallback
        function calcAQI(pm25) {
            let c=pm25, i_lo, i_hi, c_lo, c_hi;
            if (c<=12.0){c_lo=0;c_hi=12.0;i_lo=0;i_hi=50;}
            else if (c<=35.4){c_lo=12.1;c_hi=35.4;i_lo=51;i_hi=100;}
            else if (c<=55.4){c_lo=35.5;c_hi=55.4;i_lo=101;i_hi=150;}
            else {c_lo=55.5;c_hi=150.4;i_lo=151;i_hi=200;}
            return Math.round(((i_hi-i_lo)/(c_hi-c_lo))*(c-c_lo)+i_lo);
        }

        // Vẽ biểu đồ Line
        let myChart;
        function drawChart(history) {
            const data = history.slice(-24); // Lấy 24 điểm cuối
            const labels = data.map(d => new Date(d.timestamp).getHours() + 'h');
            
            const ctx = document.getElementById('mainChart');
            if(myChart) myChart.destroy();
            
            myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'PM2.5 Trong nhà',
                        data: data.map(d => d.pm25),
                        borderColor: '#0d6efd',
                        tension: 0.4,
                        fill: true,
                        backgroundColor: 'rgba(13, 110, 253, 0.1)'
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        // Chạy ngay và lặp lại
        fetchAllData();
        setInterval(fetchAllData, 300000); // 5 phút cập nhật 1 lần
    </script>
</body>
</html>
